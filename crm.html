<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM – ניהול לידים</title>
<style>
  body {
    font-family: 'Heebo', Arial, sans-serif;
    margin: 0;
    padding: 2rem;
    background: #f7f9fb;
    color: #333;
  }
  h1 { margin-bottom: 1rem; text-align: center; color: #4a5bd7; }
  h2 { text-align: center; }
  .hidden { display: none; }
  #loginDiv, #crmDiv { max-width: 1000px; margin: 0 auto; }
  #loginDiv input {
    display: block; width: 100%; padding: 0.8rem; margin-bottom: 1rem;
    border: 1px solid #ccc; border-radius: 8px; font-size: 0.9rem;
  }
  #loginDiv button {
    padding: 0.8rem 2rem; background: #4a5bd7; color: #fff;
    border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;
  }
  .crm-actions { text-align: center; margin-bottom: 1rem; }
  .crm-actions button {
    margin: 0 0.5rem; padding: 0.6rem 1.4rem; font-size: 0.9rem;
    border: none; border-radius: 6px; cursor: pointer; color: white;
    background: #4a5bd7;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 1rem; background: #fff;
    border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 0.8rem; border-bottom: 1px solid #eee; text-align: center;
  }
  th { background: #eef1fa; font-weight: 700; }
  tr:last-child td { border-bottom: none; }
  #leadsTable select,
  #leadsTable input[type="text"] {
    width: 100%; padding: 0.4rem; border: 1px solid #ccc;
    border-radius: 6px; box-sizing: border-box;
  }
  /* רוחב מינימלי לעמודות ספציפיות */
  #leadsTable th:nth-child(5),
  #leadsTable td:nth-child(5) { min-width: 120px; }  /* סטטוס */
  #leadsTable th:nth-child(6),
  #leadsTable td:nth-child(6) { min-width: 80px; }   /* מחיר */
  #leadsTable th:nth-child(8),
  #leadsTable td:nth-child(8) { min-width: 150px; }  /* הערות */
  #leadsTable th:nth-child(9),
  #leadsTable td:nth-child(9) { min-width: 170px; }  /* פעולות */
  @media print {
    body * { visibility: hidden; }
    #crmDiv, #crmDiv * { visibility: visible; }
    #crmDiv { position: absolute; left: 0; top: 0; width: 100%; }
  }
</style>
</head>
<body>

<h1>מערכת ניהול לידים</h1>

<!-- התחברות -->
<div id="loginDiv">
  <input type="email" id="loginEmail" placeholder="אימייל מנהל">
  <input type="password" id="loginPass" placeholder="סיסמה">
  <button id="loginBtn">התחברות</button>
</div>

<!-- אזור CRM -->
<div id="crmDiv" class="hidden">
  <h2 id="tableTitle">לידים קיימים</h2>
  <div class="crm-actions">
    <button id="addLeadBtn">הוסף ליד ידני</button>
    <button id="toggleArchiveBtn">צפה בארכיון</button>
    <button id="exportCsvBtn">ייצוא לאקסל</button>
    <button id="printBtn">הדפס</button>
  </div>
  <table id="leadsTable">
    <thead>
      <tr>
        <th>שם</th><th>טלפון</th><th>אימייל</th><th>שירות</th>
        <th>סטטוס</th><th>מחיר</th><th>הודעה</th><th>הערות</th><th>פעולות</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, updateDoc,
    doc, addDoc, deleteDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { firebaseConfig } from "./firebase-config.js";

  // init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // DOM elements
  const loginDiv     = document.getElementById('loginDiv');
  const crmDiv       = document.getElementById('crmDiv');
  const loginBtn     = document.getElementById('loginBtn');
  const leadsTableBody = document.querySelector('#leadsTable tbody');
  const addLeadBtn      = document.getElementById('addLeadBtn');
  const exportCsvBtn    = document.getElementById('exportCsvBtn');
  const printBtn        = document.getElementById('printBtn');
  const toggleArchiveBtn= document.getElementById('toggleArchiveBtn');
  const tableTitle      = document.getElementById('tableTitle');

  let viewingArchive = false;

  // login logic
  loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value;
    const pass  = document.getElementById('loginPass').value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert('שגיאה בהתחברות: ' + err.message);
    }
  });

  // auth state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginDiv.classList.add('hidden');
      crmDiv.classList.remove('hidden');
      loadLeads();
    } else {
      loginDiv.classList.remove('hidden');
      crmDiv.classList.add('hidden');
    }
  });

  // load leads (regular or archive)
  async function loadLeads() {
    leadsTableBody.innerHTML = '';
    const collectionName = viewingArchive ? 'leads_archive' : 'leads';
    const querySnapshot  = await getDocs(collection(db, collectionName));
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      // צור קישורי WhatsApp ו-Mail
      const phoneRaw = data.phone || '';
      let phoneIntl  = phoneRaw.replace(/\D/g, '');
      if (phoneIntl && phoneIntl.startsWith('0')) {
        phoneIntl = '972' + phoneIntl.substring(1);
      }
      const whatsappLink = phoneIntl ? `https://wa.me/${phoneIntl}` : '';
      const emailLink    = data.email ? `mailto:${data.email}` : '';
      // בנה שורה
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.name || ''}</td>
        <td>${data.phone || ''}</td>
        <td>${data.email || ''}</td>
        <td>${data.service || ''}</td>
        <td>
          <select ${viewingArchive ? 'disabled' : ''} data-id="${docSnap.id}" data-field="status">
            <option value="חדש" ${data.status === 'חדש' ? 'selected' : ''}>חדש</option>
            <option value="בטיפול" ${data.status === 'בטיפול' ? 'selected' : ''}>בטיפול</option>
            <option value="בוצע" ${data.status === 'בוצע' ? 'selected' : ''}>בוצע</option>
            <option value="סגור" ${data.status === 'סגור' ? 'selected' : ''}>סגור</option>
          </select>
        </td>
        <td><input type="text" ${viewingArchive ? 'disabled' : ''} value="${data.price || ''}" data-id="${docSnap.id}" data-field="price"></td>
        <td>${data.message || ''}</td>
        <td><input type="text" ${viewingArchive ? 'disabled' : ''} value="${data.notes || ''}" data-id="${docSnap.id}" data-field="notes"></td>
        <td>
          ${viewingArchive
            ? `<button class="restore-btn" data-id="${docSnap.id}">השב</button>`
            : `<button class="edit-btn" data-id="${docSnap.id}">ערוך</button>
               <button class="delete-btn" data-id="${docSnap.id}">מחק</button>
               ${whatsappLink ? `<a href="${whatsappLink}" target="_blank">וואטסאפ</a>` : ''}
               ${emailLink    ? `<a href="${emailLink}" target="_blank">מייל</a>`     : ''}`
          }
        </td>
      `;
      leadsTableBody.appendChild(tr);
    });

    // עריכת שדות פעילים
    if (!viewingArchive) {
      leadsTableBody.querySelectorAll('select, input[type="text"]').forEach(el => {
        el.addEventListener('change', async (e) => {
          const id    = e.target.getAttribute('data-id');
          const field = e.target.getAttribute('data-field');
          const value = e.target.value;
          const docRef = doc(db, 'leads', id);
          try {
            await updateDoc(docRef, { [field]: value });
          } catch (err) {
            console.error('Error updating document:', err);
          }
        });
      });
      // עריכה
      leadsTableBody.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id     = e.target.getAttribute('data-id');
          const docRef = doc(db, 'leads', id);
          const snap   = await getDoc(docRef);
          const data   = snap.data();
          // prompts
          const name    = prompt('שם מלא:', data.name || '');
          const phone   = prompt('טלפון:', data.phone || '');
          const email   = prompt('אימייל (לא חובה):', data.email || '');
          const service = prompt('שירות:', data.service || '');
          const message = prompt('הודעה/הערות:', data.message || '');
          const status  = prompt('סטטוס (חדש/בטיפול/בוצע/סגור):', data.status || 'חדש');
          const price   = prompt('מחיר:', data.price || '');
          const notes   = prompt('הערות מנהל:', data.notes || '');
          await updateDoc(docRef, {
            name, phone, email, service,
            message, status, price, notes
          });
          await loadLeads();
        });
      });
      // מחיקה
      leadsTableBody.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          try {
            const docRef  = doc(db, 'leads', id);
            const docSnap = await getDoc(docRef);
            const data    = docSnap.data();
            await addDoc(collection(db, 'leads_archive'), data);
            await deleteDoc(docRef);
            await loadLeads();
          } catch (err) {
            console.error('Error deleting document:', err);
          }
        });
      });
    } else {
      // השבת ליד מהארכיון
      leadsTableBody.querySelectorAll('.restore-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          try {
            const docRef  = doc(db, 'leads_archive', id);
            const docSnap = await getDoc(docRef);
            const data    = docSnap.data();
            await addDoc(collection(db, 'leads'), data);
            await deleteDoc(docRef);
            await loadLeads();
          } catch (err) {
            console.error('Error restoring document:', err);
          }
        });
      });
    }
  }

  // toggle archive
  function toggleArchive() {
    viewingArchive = !viewingArchive;
    tableTitle.textContent = viewingArchive ? 'לידים בארכיון' : 'לידים קיימים';
    toggleArchiveBtn.textContent = viewingArchive ? 'חזור לרשימה' : 'צפה בארכיון';
    loadLeads();
  }

  // add lead manually
  async function addLeadManually() {
    const name    = prompt('שם מלא:');
    const phone   = prompt('טלפון:');
    const email   = prompt('אימייל (לא חובה):');
    const service = prompt('שירות:');
    const message = prompt('הודעה/הערות:');
    if (!name || !phone || !service) {
      alert('חובה למלא שם, טלפון ושירות');
      return;
    }
    const data = {
      name,
      phone,
      email: email || '',
      service,
      message: message || '',
      status: 'חדש',
      price: '',
      notes: '',
      source: 'admin',
      createdAt: new Date()
    };
    await addDoc(collection(db, 'leads'), data);
    await loadLeads();
  }

  // export CSV
  async function exportCsv() {
    const col = viewingArchive ? 'leads_archive' : 'leads';
    const snap = await getDocs(collection(db, col));
    const rows = [];
    rows.push(['שם','טלפון','אימייל','שירות','סטטוס','מחיר','הודעה','הערות','מקור']);
    snap.forEach(docSnap => {
      const d = docSnap.data();
      rows.push([
        d.name || '', d.phone || '', d.email || '', d.service || '',
        d.status || '', d.price || '', d.message || '', d.notes || '', d.source || ''
      ]);
    });
    const csv = rows.map(r => r.map(i => `"${String(i).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = (viewingArchive ? 'leads_archive' : 'leads') + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // event listeners
  addLeadBtn.addEventListener('click', addLeadManually);
  toggleArchiveBtn.addEventListener('click', toggleArchive);
  exportCsvBtn.addEventListener('click', exportCsv);
  printBtn.addEventListener('click', () => window.print());
</script>

</body>
</html>
